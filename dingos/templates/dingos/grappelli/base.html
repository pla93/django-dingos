{% extends "mantis/grappelli/base.html" %}

{% comment %}
Copyright (c) Siemens AG, 2013

This file is part of MANTIS.  MANTIS is free software: you can
redistribute it and/or modify it under the terms of the GNU General Public
License as published by the Free Software Foundation; either version 2
of the License, or(at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
details.

You should have received a copy of the GNU General Public License along with
this program; if not, write to the Free Software Foundation, Inc., 51
Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
{% endcomment %}


{% load static %}
{% load dingos_tags %}

{% block title %}
  {% create_title title %}
{% endblock %}

{% block stylesheets %}
  {{ block.super }}
  <link href="{% static 'dingos/css/django-dingos.css' %}" rel="stylesheet" type="text/css" media="screen" />
{% endblock %}

{% block javascripts %}
  {{ block.super }}
  <script type="text/javascript" charset="utf-8">
    var $ = django.jQuery;
    var jQuery = django.jQuery;
  </script>
  <script src="{% static 'dingos/js/django-dingos.js' %}"></script>
  <script type="text/javascript" charset="utf-8">
(function($) {
  function add_removeHandler(){
    $('.remove_tag_button').each(function(){
      $(this).click(function (event) {
        var tag_name = $(event.target).data('tag-name');
        var obj_info = $(event.target).closest('tr');
        console.log(obj_info);
        var obj_id = obj_info.data('obj-id');
        var obj_type = obj_info.data('obj-type');
        $.ajax({
          url: "/mantis/tagging/remove",
            type: "POST",
            data: JSON.stringify({ tag: tag_name, objects: [obj_id], type: obj_type}) ,
            processData: false,
            contentType: 'application/json; charset=UTF-8',
            dataType: "json"
        });
        //TODO success msg/err
        if(obj_id != null){
          $(event.target).parent().remove();
        }
    });
    });
  }

    $(document).ready(function () {
      //register removeHandler for all tags
      add_removeHandler();

      //bind keypress event to all tag input fields
      $('input#id_tag').each(function(){
        $(this).keypress(function(event){
          if(event.isDefaultPrevented()){
            return;
          }
          //TODO check if event.key is supported by all browsers
          //https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent
          //ASCII 13 --> Carriage Return
          if(event.keyCode === 13){
            var tag_name = $(event.target).val();
            var obj_info = $(event.target).closest('tr');
            var obj_id = obj_info.data('obj-id');
            var obj_type = obj_info.data('obj-type');
            var tag_container = $('td#tags_' + obj_id);
            if(tag_name != "" && tag_container.children("span#" + tag_name).length == 0) {
              $.ajax({
                url: "/mantis/tagging/add",
                type: "POST",
                data: JSON.stringify({ tag: tag_name, objects: [obj_id], type: obj_type}) ,
                processData: false,
                contentType: 'application/json; charset=UTF-8',
                dataType: "json",
                success: function (resp) {
                  var tag = '<span id="' + resp.name + '" class="tag">' + resp.name + '<a href="#" class="remove_tag_button" data-tag-name="' + resp.name + '"> X</a></span>';
                  tag_container.append(tag);
                  add_removeHandler();
                }
              });
            }
            event.preventDefault();
          }});
        });
    });
})(django.jQuery);
  </script>
{% endblock javascripts %}

{% block content_title %}
  <h1>{{ title }}</h1>
{% endblock %}

